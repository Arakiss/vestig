# =============================================================================
# Vestig Release Pipeline
# =============================================================================
# Automatically creates releases based on Conventional Commits
#
# Commit Types:
#   feat: â†’ MINOR version bump (0.17.0 â†’ 0.18.0)
#   fix:  â†’ PATCH version bump (0.17.0 â†’ 0.17.1)
#   perf: â†’ PATCH version bump
#   feat!: â†’ MINOR bump while on 0.x.x (major_on_zero=false)
#
# NOTE: v1.0.0 requires manual release (major bumps disabled in 0.x.x)
#
# Other types (docs, style, refactor, test, build, ci, chore) don't bump version
# =============================================================================

name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_version:
        description: 'Force version bump (leave empty for auto)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  BUN_VERSION: 'latest'

jobs:
  # ===========================================================================
  # Semantic Release
  # ===========================================================================
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Build first - required for typecheck to resolve workspace dependencies
      - name: Build packages
        run: bun run build

      - name: Run type checking
        run: bun run typecheck

      - name: Run tests
        run: bun run test

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # =========================================================================
      # Analyze commits and determine version bump
      # =========================================================================
      - name: Analyze commits for version bump
        id: analyze
        run: |
          # Get the last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

          # Get commits since last tag
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          echo "Commits since $LAST_TAG:"
          echo "$COMMITS"

          # Determine version bump type based on conventional commits
          BUMP_TYPE=""

          # Check for breaking changes (feat!:, fix!:, etc.)
          if echo "$COMMITS" | grep -qE "^[a-z]+!:"; then
            # While on 0.x.x, breaking changes bump minor (not major)
            BUMP_TYPE="minor"
            echo "Breaking change detected (bumping minor while on 0.x.x)"
          # Check for features
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            BUMP_TYPE="minor"
            echo "Feature detected"
          # Check for fixes/perf
          elif echo "$COMMITS" | grep -qE "^(fix|perf)(\(.+\))?:"; then
            BUMP_TYPE="patch"
            echo "Fix/perf detected"
          else
            echo "No version-bumping commits found"
          fi

          # Override with manual input if provided
          if [ -n "${{ github.event.inputs.force_version }}" ]; then
            BUMP_TYPE="${{ github.event.inputs.force_version }}"
            echo "Manual override: $BUMP_TYPE"
          fi

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

          if [ -z "$BUMP_TYPE" ]; then
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      # =========================================================================
      # Skip if no release needed
      # =========================================================================
      - name: Skip release
        if: steps.analyze.outputs.should_release == 'false'
        run: |
          echo "No version-bumping commits found. Skipping release."
          echo "## Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No version-bumping commits found since last release." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit types that trigger releases:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat:\` â†’ Minor version bump" >> $GITHUB_STEP_SUMMARY
          echo "- \`fix:\` â†’ Patch version bump" >> $GITHUB_STEP_SUMMARY
          echo "- \`perf:\` â†’ Patch version bump" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat!:\` or \`fix!:\` â†’ Minor bump (breaking change)" >> $GITHUB_STEP_SUMMARY

      # =========================================================================
      # Create Release (Dry Run)
      # =========================================================================
      - name: Release (Dry Run)
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.dry_run == 'true'
        run: |
          echo "DRY RUN - No changes will be made"
          bun run release -- --ci --dry-run --increment=${{ steps.analyze.outputs.bump_type }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # =========================================================================
      # Create Release
      # =========================================================================
      - name: Create Release
        id: release
        if: steps.analyze.outputs.should_release == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          echo "Creating ${{ steps.analyze.outputs.bump_type }} release..."
          bun run release -- --ci --increment=${{ steps.analyze.outputs.bump_type }}

          # Get the new version
          VERSION=$(node -p "require('./packages/vestig/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # =========================================================================
      # Publish to npm
      # =========================================================================
      - name: Setup Node.js for npm publish
        if: steps.release.outputs.released == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Publish vestig to npm
        id: npm_vestig
        if: steps.release.outputs.released == 'true'
        run: |
          cd packages/vestig
          npm publish --access public
          echo "Published vestig@${{ steps.release.outputs.version }} to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish @vestig/next to npm
        id: npm_vestig_next
        if: steps.release.outputs.released == 'true'
        run: |
          cd packages/vestig-next
          npm publish --access public
          echo "Published @vestig/next@${{ steps.release.outputs.version }} to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}
      bump_type: ${{ steps.analyze.outputs.bump_type }}

  # ===========================================================================
  # Post-Release Summary
  # ===========================================================================
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.released == 'true'

    steps:
      - name: Create Summary
        run: |
          echo "## ðŸš€ Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ needs.release.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… What happened:" >> $GITHUB_STEP_SUMMARY
          echo "- Version bumped in package.json" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG.md updated with conventional commits" >> $GITHUB_STEP_SUMMARY
          echo "- Git tag ${{ needs.release.outputs.tag }} created" >> $GITHUB_STEP_SUMMARY
          echo "- Changes pushed to main" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release created" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Published \`vestig@${{ needs.release.outputs.version }}\` to npm" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Published \`@vestig/next@${{ needs.release.outputs.version }}\` to npm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.release.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
          echo "- [vestig on npm](https://www.npmjs.com/package/vestig)" >> $GITHUB_STEP_SUMMARY
          echo "- [@vestig/next on npm](https://www.npmjs.com/package/@vestig/next)" >> $GITHUB_STEP_SUMMARY
